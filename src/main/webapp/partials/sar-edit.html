<script type="text/ng-template" id="userTemplate.html">
    <a>{{match.label}} <span x-ng-show="match.model.mmsi">({{match.model.mmsi}})</span></a>
</script>

<div x-ng-controller="SAROperationEditController">

    <script type="text/ng-template" id="directionTemplate.html">
        <span>
            <span bind-html-unsafe="match.label | typeaheadHighlight:query"></span>
            ({{match.model.degrees}}°)
        </span>
    </script>

    <div e-reporting-panel x-ng-if="provider.doShow" id="sarOperationEditPanel">
        <h2>
            <a class="close" href="#" style="float: right" x-ng-click="close($event)">&times;</a>SAR Operation
        </h2>

        <div>
            <form x-ng-if="page.name == 'typeSelection'" name="sarTypeForm" class="form-horizontal" novalidate>
                <hr/>
                <div x-ng-show="alertMessages" class="alert alert-danger">
                    <span x-ng-repeat="msg in alertMessages">{{msg}}<br/></span>
                </div>
                <div x-ng-show="message" class="alert alert-info">{{message}}</div>

                <div class="form-group">
                    <label class="control-label col-xs-3">Identifier</label>

                    <div class="col-xs-4 txt"><span>{{sar.no}}</span></div>
                </div>
                <hr/>

                <div class="form-group">
                    <label class="control-label col-xs-3">Sar Operation Type</label>

                    <div class="col-xs-5">
                        <select ng-model="sar.type" name="type" required
                                class="input-sm form-control"
                                x-ng-options="sarTypeDatas[type].text group by sarTypeDatas[type].group for (key,type) in sarTypeValues">
                        </select>
                    </div>
                </div>

                <div>
                    <p x-ng-if="sar.type === sarTypes.RapidResponse">
                        {{sarTypeDatas[sar.type].text}} should be used when the rescue vessel is within the designated
                        search area in a relatively short time span, i.e. 1-2 hours after last known position (LKP).
                    </p>

                    <p x-ng-if="sar.type === sarTypes.DatumPoint">
                        {{sarTypeDatas[sar.type].text}} is a calculation method used when the rescue vessel arrives to
                        the
                        designated search area two hours or more later than the last known position (LKP) was reported.
                    </p>

                    <p x-ng-if="sar.type === sarTypes.DatumLine">
                        {{sarTypeDatas[sar.type].text}} is used when an object is missing and the last known position
                        (LKP) is unknown, but an assumed route is known.
                    </p>

                    <p x-ng-if="sar.type === sarTypes.BackTrack">
                        {{sarTypeDatas[sar.type].text}} is used when an object connected to the missing vessel has
                        been located. By reversing the objects movements a possible search area can be established.
                    </p>
                    <p x-ng-if="sar.type === sarTypes.TrackLine">
                        Track line search is normally employed when an aircraft or vessel has disappeared
                        without a trace while en <i>route</i> from one point to another. The track line search consists
                        of a rapid and reasonably thorough search along the intended route of the distressed craft.
                    </p>
                </div>

                <div class="sar-img-type-container" style="text-align: center;">
                    <img style="max-width:500px; max-height:250px" ng-if="sar.type" ng-src="{{sarTypeDatas[sar.type].img}}"/>
                </div>

                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="next()">Next</button>
                    </span>
                </div>
            </form>
            <form x-ng-if="page.name == 'sarInputs'" name="sarOperationForm" class="form-horizontal" novalidate>
                <hr/>
                <div x-ng-show="alertMessages" class="alert alert-danger">
                    <span x-ng-repeat="msg in alertMessages">{{msg}}<br/></span>
                </div>
                <div x-ng-show="message" class="alert alert-info">{{message}}</div>

                <h5>{{tmp.sarTypeData.text}}</h5>

                <div x-ng-if="sar.type === sarTypes.DatumLine">
                    <h5>Drift Search Positions</h5>
                    <table class="table dsps" x-ng-if="sar.dsps && sar.dsps.length > 0">
                        <thead>
                        <tr>
                            <th>DSP</th>
                            <th>Time</th>
                            <th>Position</th>
                            <th>Position Error (X)</th>
                            <th></th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody x-ng-repeat="dsp in sar.dsps">
                        <tr>
                            <td>{{$index + 1}}</td>
                            <td>{{formatTs(dsp.ts)}}</td>
                            <td>{{formatPos(dsp)}}</td>
                            <td>{{dsp.xError ? dsp.xError + ' nm' : ''}}</td>
                            <td>
                                <button type="button" class="btn btn-sm" x-ng-click="editDSP($index)">Edit</button></td>
                            <td>
                                <button type="button" class="btn btn-sm" x-ng-click="removeDSP(sar.dsps, $index)"
                                        x-ng-disabled="sar.dsps.length <= 2">Remove</button></td>
                        </tr>
                        <tr x-ng-repeat="surfaceDrift in dsp.surfaceDrifts" class="surfaceDrift">
                            <td colspan="2">TWC: {{surfaceDrift.twcSpeed}} knots / {{surfaceDrift.twcDirection}}°</td>
                            <td colspan="3">Leeway: {{surfaceDrift.leewaySpeed}} knots / {{surfaceDrift.leewayDirection}}°</td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="form-group">
                        <div class="col-xs-offset-5 col-xs-7">
                            <span class="pull-right">
                                <button type="button" class="btn btn-sm" x-ng-click="addDSP()">Add drift search position</button>
                            </span>
                        </div>
                    </div>
                    <hr/>
                </div>

                <div x-ng-if="sar.type !== sarTypes.DatumLine">
                    <h5>Last known position</h5>

                    <div class="form-group">
                        <label class="control-label col-xs-2">Latitude</label>

                        <div class="col-xs-3">
                            <input latitude2 x-ng-model="sar.lastKnownPosition.lat" type="text" name="lkpLat"
                                   class="form-control input-sm lat" placeholder="61 15.856N" required/>
                            <span x-ng-if="sarOperationForm.lkpLat.$error.latitude" class="error-block">
                                Use correct format, e.g. 04 34.023N
                            </span>
                        </div>

                        <label class="control-label col-xs-3">Longitude</label>

                        <div class="col-xs-3">
                            <input longitude2 x-ng-model="sar.lastKnownPosition.lon" type="text" name="lkpLon"
                                   class="form-control input-sm lon" placeholder="049 53 844W" required/>
                            <span x-ng-if="sarOperationForm.lkpLon.$error.longitude" class="error-block">
                                Use correct format, e.g. 004 04.033E
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-2">Time</label>

                        <div class="col-xs-4">
                            <datetimepicker x-ng-model="sar.lastKnownPosition.ts"/>
                        </div>
                        <label class="control-label col-xs-3">Position Error (X), nm</label>

                        <div class="col-xs-2">
                            <input x-ng-model="sar.xError" name="xError" type="number" class="form-control input-sm"
                                   required/>
                        </div>
                    </div>
                    <hr/>
                </div>

                <h5>Commence search start</h5>

                <div class="form-group">
                    <label class="control-label col-xs-3">Time of Search Start</label>

                    <div class="col-xs-4">
                        <datetimepicker name="searchStartTs" x-ng-model="sar.startTs"/>
                    </div>
                </div>

                <hr/>

                <div x-ng-if="sar.type !== sarTypes.DatumLine">
                    <h5>Surface drift</h5>
                    <div>
                        <div class="form-group">
                            <div class="col-xs-offset-5 col-xs-7">
                                <span class="pull-right">
                                    <button type="button" class="btn btn-sm" x-ng-click="addPoint()">Add point</button>
                                    <button type="button" class="btn btn-sm" x-ng-click="removePoint()"
                                            x-ng-disabled="sar.surfaceDriftPoints.length <= 1">Remove last
                                    </button>
                                </span>
                            </div>
                        </div>

                        <table class="table surfaceDriftPoints">
                            <thead>
                            <tr>
                                <th>Time</th>
                                <th>TWC</th>
                                <th>TWC direction</th>
                                <th>Leeway</th>
                                <th>Leeway direction</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr ng-form="surfaceDriftPointForm" x-ng-repeat="surfaceDriftPoint in sar.surfaceDriftPoints">
                                <td>
                                    <div x-ng-if="$index == 0">
                                        <datetimepicker name="surfaceDriftPointTs" x-ng-model="surfaceDriftPoint.ts"
                                                        lteq="sar.lastKnownPosition.ts"/>
                                        <span x-ng-if="surfaceDriftPointForm.surfaceDriftPointTs.$error.lteq" class="error-block">
                                            Surface drift point must be before last known position.
                                        </span>
                                    </div>
                                    <div x-ng-if="$index == 1">
                                        <datetimepicker name="surfaceDriftTs2" x-ng-model="surfaceDriftPoint.ts"
                                                        gteq="sar.lastKnownPosition.ts"/>
                                        <span x-ng-if="surfaceDriftPointForm.surfaceDriftTs2.$error.gteq" class="error-block">
                                            Surface drift point must be after last known position.
                                        </span>
                                    </div>
                                    <div x-ng-if="$index > 1">
                                        <datetimepicker name="surfaceDriftTs3" x-ng-model="surfaceDriftPoint.ts"
                                                        gteq="sar.surfaceDriftPoints[$index - 1].ts"/>
                                        <span x-ng-if="surfaceDriftPointForm.surfaceDriftTs3.$error.gteq" class="error-block">
                                            Surface drift point must be after the previous one.
                                        </span>
                                    </div>
                                </td>
                                <td><input x-ng-model="surfaceDriftPoint.twcSpeed" type="text"
                                           class="form-control input-sm" placeholder="5 knots"
                                           required/></td>
                                <td>
                                    <input x-ng-model="surfaceDriftPoint.twcDirection" type="text"
                                           class="form-control input-sm"
                                           x-typeahead="direction.name for direction in getDirections($viewValue)"
                                           typeahead-template-url="directionTemplate.html" placeholder="W/270°" required/>
                                </td>
                                <td><input x-ng-model="surfaceDriftPoint.leewaySpeed" type="text"
                                           class="form-control input-sm" placeholder="15 knots" required/></td>
                                <td><input x-ng-model="surfaceDriftPoint.leewayDirection" type="text"
                                           class="form-control input-sm"
                                           x-typeahead="direction.name for direction in getDirections($viewValue)"
                                           typeahead-template-url="directionTemplate.html" placeholder="NE/45°" required/>
                                </td>
                            </tr>
                            </tbody>

                        </table>
                    </div>
                </div>


                <hr/>
                <h5>Other variables</h5>

                <div class="form-group">
                    <label class="control-label col-xs-3">SRU Navigational Error (Y), nm</label>

                    <div class="col-xs-4">
                        <input x-ng-model="sar.yError" name="yError" type="number" class="form-control input-sm"
                               required/>
                    </div>
                    <span class="help-block">Note: GPS = 0.1 nm</span>
                </div>
                <div class="form-group">
                    <label class="control-label col-xs-3">Safety factor, Fs</label>

                    <div class="col-xs-4">
                        <input x-ng-model="sar.safetyFactor" name="safetyFactor" type="number"
                               class="form-control input-sm" required/>
                    </div>
                </div>

                <hr/>
                <h5>Search object</h5>

                <div class="form-group">
                    <div class="col-xs-7" for="sar.searchObject">
                        <select ng-model="sar.searchObject" id="sar.searchObject" name="sar.searchObject" required
                                class="input-sm form-control"
                                x-ng-options="searchObject.id as searchObject.text for searchObject in searchObjects">
                        </select>
                    </div>
                    <span class="help-block">{{searchObjects[sar.searchObject].x}} x U<span x-ng-if="searchObjects[sar.searchObject].y >= 0"> + {{searchObjects[sar.searchObject].y}}</span>
                        <span x-ng-if="searchObjects[sar.searchObject].y < 0"> - {{-1*searchObjects[sar.searchObject].y}}</span>, Divergence {{searchObjects[sar.searchObject].divergence}}
                    </span>
                </div>

                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-sm" x-ng-click="back()">Back</button> &nbsp;
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="createSarOperation()"
                                x-ng-disabled="sarOperationForm.$invalid">Next
                        </button>
                    </span>
                </div>
            </form>
            <form x-ng-if="page.name == 'drift'" name="btForm" class="form-horizontal" novalidate>
                <hr/>
                <div x-ng-show="alertMessages" class="alert alert-danger">
                    <span x-ng-repeat="msg in alertMessages">{{msg}}<br/></span>
                </div>
                <div x-ng-show="message" class="alert alert-info">{{message}}</div>

                <h5>Position of found Object</h5>
                <div class="form-group">
                    <label class="control-label col-xs-2">Latitude</label>
                    <div class="col-xs-3">
                        <input latitude2 x-ng-model="sar.objectPosition.lat" type="text" name="opLat"
                               class="form-control input-sm lat" placeholder="61 15.856N" required/>
                        <span x-ng-if="sarOperationForm.opLat.$error.latitude" class="error-block">
                            Use correct format, e.g. 04 34.023N
                        </span>

                    </div>

                    <label class="control-label col-xs-3">Longitude</label>
                    <div class="col-xs-3">
                        <input longitude2 x-ng-model="sar.objectPosition.lon" type="text" name="opLon"
                               class="form-control input-sm lon" placeholder="049 53 844W" required/>
                        <span x-ng-if="sarOperationForm.opLon.$error.longitude" class="error-block">
                            Use correct format, e.g. 004 04.033E
                        </span>

                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-xs-2">Time</label>
                    <div class="col-xs-4">
                        <datetimepicker x-ng-model="sar.objectPosition.ts"/>
                    </div>

                    <label class="control-label col-xs-3">Position Error (X), nm</label>
                    <div class="col-xs-2">
                        <input x-ng-model="sar.xError" name="xError" type="number" class="form-control input-sm"
                               required/>
                    </div>
                </div>
                <hr/>

                <h5>Calculate drift back until</h5>
                <div class="form-group">
                    <label class="control-label col-xs-1">Time</label>
                    <div class="col-xs-4">
                        <datetimepicker x-ng-model="sar.driftFromTs" lteq="sar.objectPosition.ts" name="driftFromTs"/>
                        <span x-ng-if="btForm.driftFromTs.$error.lteq" class="error-block">
                             Drift must be calculated from a time before the object was found.
                        </span>

                    </div>
                </div>
                <hr/>

                <div>
                    <h5>Surface drift</h5>
                    <div>
                        <div class="form-group">
                            <div class="col-xs-offset-5 col-xs-7">
                                <span class="pull-right">
                                    <button type="button" class="btn btn-sm" x-ng-click="addPoint()">Add point</button>
                                    <button type="button" class="btn btn-sm" x-ng-click="removePoint()"
                                            x-ng-disabled="sar.surfaceDrifts.length <= 1">Remove last
                                    </button>
                                </span>
                            </div>
                        </div>

                        <table class="table surfaceDriftPoints">
                            <thead>
                            <tr>
                                <th>Time</th>
                                <th>TWC</th>
                                <th>TWC direction</th>
                                <th>Leeway</th>
                                <th>Leeway direction</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr ng-form="surfaceDriftForm" x-ng-repeat="surfaceDrift in sar.surfaceDriftPoints">
                                <td>
                                    <datetimepicker name="surfaceDriftTs" x-ng-model="surfaceDrift.ts"
                                                    lteq="sar.driftFromTs"/>
                                <span x-ng-if="surfaceDriftForm.surfaceDriftTs.$error.lteq" class="error-block">
                                    Surface drift point must be before the time the drift is calculated back to
                                </span>
                                </td>
                                <td><input x-ng-model="surfaceDrift.twcSpeed" type="text"
                                           class="form-control input-sm" placeholder="5 knots"
                                           required/></td>
                                <td>
                                    <input x-ng-model="surfaceDrift.twcDirection" type="text"
                                           class="form-control input-sm"
                                           x-typeahead="direction.name for direction in getDirections($viewValue)"
                                           typeahead-template-url="directionTemplate.html" placeholder="W/270°" required/>
                                </td>
                                <td><input x-ng-model="surfaceDrift.leewaySpeed" type="text"
                                           class="form-control input-sm" placeholder="15 knots" required/></td>
                                <td><input x-ng-model="surfaceDrift.leewayDirection" type="text"
                                           class="form-control input-sm"
                                           x-typeahead="direction.name for direction in getDirections($viewValue)"
                                           typeahead-template-url="directionTemplate.html" placeholder="NE/45°" required/>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <hr/>


                <h5>Found object</h5>

                <div class="form-group">
                    <div class="col-xs-7" for="sar.searchObject">
                        <select ng-model="sar.searchObject" id="btFoundObject" name="btFoundObject" required
                                class="input-sm form-control"
                                x-ng-options="searchObject.id as searchObject.text for searchObject in searchObjects">
                        </select>
                    </div>
                    <span class="help-block">{{searchObjects[sar.searchObject].x}} x U<span x-ng-if="searchObjects[sar.searchObject].y >= 0"> + {{searchObjects[sar.searchObject].y}}</span>
                        <span x-ng-if="searchObjects[sar.searchObject].y < 0"> - {{-1*searchObjects[sar.searchObject].y}}</span>, Divergence {{searchObjects[sar.searchObject].divergence}}
                    </span>
                </div>

                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-sm" x-ng-click="page.name='typeSelection'">Back</button> &nbsp;
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="createBackTrack()"
                                x-ng-disabled="btForm.$invalid">Next
                        </button>
                    </span>
                </div>
            </form>

            <form x-ng-if="page.name == 'route'" name="routeForm" class="form-horizontal" novalidate>
                <hr/>
                <div x-ng-show="alertMessages" class="alert alert-danger">
                    <span x-ng-repeat="msg in alertMessages">{{msg}}<br/></span>
                </div>
                <div x-ng-show="message" class="alert alert-info">{{message}}</div>

                <h5>Planed route of found Object</h5>
                <div class="form-group">
                    <div class="col-xs-offset-5 col-xs-7">
                        <span class="pull-right">
                            <button type="button" class="btn btn-sm" x-ng-click="sar.planedRoute.points.push({})">Add point</button>
                            <button type="button" class="btn btn-sm" x-ng-click="sar.planedRoute.points.splice(sar.planedRoute.points.length - 1, 1)"
                                    x-ng-disabled="sar.planedRoute.points.length <= 1">Remove last
                            </button>
                        </span>
                    </div>
                </div>

                <table class="table surfaceDriftPoints">
                    <thead>
                    <tr>
                        <th>Time</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-form="rpForm" x-ng-repeat="point in sar.planedRoute.points">
                        <td>
                            <div x-ng-if="$index==0 && page.next=='lkp'">
                                <datetimepicker name="pointTs" x-ng-model="point.ts"
                                                lteq="sar.objectPosition.ts"/>
                                <span x-ng-if="rpForm.pointTs.$error.lteq" class="error-block">
                                    Time of first planed route point must be before time of registered position for found object
                                </span>
                            </div>
                            <div x-ng-if="$index > 0 || page.next!='lkp'">
                                <datetimepicker name="pointTs" x-ng-model="point.ts"/>
                            </div>
                        </td>
                        <td>
                            <input latitude2 x-ng-model="point.lat" type="text" name="pointLat"
                                   class="form-control input-sm lat" placeholder="61 15.856N" required/>
                            <span x-ng-if="rpForm.pointLat.$error.latitude" class="error-block">
                                Use correct format, e.g. 04 34.023N
                            </span>
                        <td>
                            <input longitude2 x-ng-model="point.lon" type="text" name="pointLon"
                                   class="form-control input-sm lon" placeholder="049 53 844W" required/>
                            <span x-ng-if="rpForm.pointLon.$error.longitude" class="error-block">
                                Use correct format, e.g. 004 04.033E
                            </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <hr/>

                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-sm" x-ng-click="page.name=page.back">Back</button> &nbsp;
                        <button type="button" class="btn btn-sm" x-ng-click="page.name=page.next">Skip</button> &nbsp;
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="saveSarOperation(page.next)"
                                x-ng-disabled="routeForm.$invalid || sar.planedRoute.points.length < 2 ">Save route
                        </button>
                    </span>
                </div>
            </form>
            <form x-ng-if="page.name == 'lkp'" name="lkpForm" class="form-horizontal" novalidate>
                <hr/>
                <div x-ng-show="alertMessages" class="alert alert-danger">
                    <span x-ng-repeat="msg in alertMessages">{{msg}}<br/></span>
                </div>
                <div x-ng-show="message" class="alert alert-info">{{message}}</div>
                <div x-ng-if="sar.selectedPositions.length == 0" class="alert alert-warning">
                    At least one positions must be selected
                </div>

                <div>
                    Click on the map to select position(s) to proceed with as last known position or drift search positions
                    in a new search and rescue operation calculation (Rapid Response, Datum Point or Datum Line)
                </div>

                <h5>Known positions</h5>
                <div x-ng-controller="BackTrackPositionSelectionController">
                    <table class="table knownPositions">
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Time</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-form="selPosForm" x-ng-repeat="position in sar.selectedPositions">
                            <td>
                                <span x-ng-if="sar.selectedPositions.length == 1">LKP</span>
                                <span x-ng-if="sar.selectedPositions.length > 1">DSP {{$index + 1}}</span>
                            </td>
                            <td>
                                <div x-ng-if="$index==0">
                                    <datetimepicker name="selPosTs" x-ng-model="position.ts"
                                                    lteq="sar.objectPosition.ts"/>
                                <span x-ng-if="selPosForm.selPosTs.$error.lteq" class="error-block">
                                    Time of known position must be before time of registered position for found object
                                </span>
                                </div>
                                <div x-ng-if="$index > 0">
                                    <datetimepicker name="selPosTs" x-ng-model="position.ts"/>
                                </div>
                            </td>
                            <td>
                                <input latitude x-ng-model="position.lat" type="text" name="selPosLat"
                                       class="form-control input-sm lat" placeholder="61 15.856N" required/>
                            <span x-ng-if="selPosForm.selPosLat.$error.latitude" class="error-block">
                                Use correct format, e.g. 04 34.023N
                            </span>
                            <td>
                                <input longitude x-ng-model="position.lon" type="text" name="selPosLon"
                                       class="form-control input-sm lon" placeholder="049 53 844W" required/>
                                <span x-ng-if="selPosForm.selPosLon.$error.longitude" class="error-block">
                                    Use correct format, e.g. 004 04.033E
                                </span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-primary btn-sm" x-ng-click="sar.selectedPositions.splice($index, 1)">
                                    Remove
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>


                </div>

                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-sm" x-ng-click="page.name='route'">Back</button> &nbsp;
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="saveSarOperation('backtrackResult')"
                                x-ng-disabled="lkpForm.$invalid && sar.selectedPositions && sar.selectedPositions.length > 0">Save
                        </button>
                    </span>
                </div>
            </form>

            <div x-ng-if="page.name == 'DSP'">
                <form name="dspForm" class="form-horizontal" novalidate x-ng-controller="SarDspController">
                    <h5>Drift Search Position</h5>

                    <div class="form-group">
                        <label class="control-label col-xs-2">Latitude</label>
                        <div class="col-xs-3">
                            <input latitude2 x-ng-model="dsp.lat" type="text" name="dspLat"
                                   class="form-control input-sm lat" placeholder="61 15.856N" required/>
                            <span x-ng-if="dspForm.dspLat.$error.latitude" class="error-block">
                                Use correct format, e.g. 04 34.023N
                            </span>

                        </div>

                        <label class="control-label col-xs-3">Longitude</label>
                        <div class="col-xs-3">
                            <input longitude2 x-ng-model="dsp.lon" type="text" name="dspLon"
                                   class="form-control input-sm lon" placeholder="049 53.844W" required/>
                            <span x-ng-if="dspForm.dspLon.$error.longitude" class="error-block">
                                Use correct format, e.g. 004 04.033E
                            </span>

                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-2">Time</label>
                        <div class="col-xs-4">
                            <datetimepicker name="ts" x-ng-model="dsp.ts" required/>
                        </div>

                        <label class="control-label col-xs-3">Position Error (X), nm</label>
                        <div class="col-xs-2">
                            <input x-ng-model="dsp.xError" name="xError" type="number" class="form-control input-sm"
                                   required/>
                        </div>
                    </div>
                    <hr/>
                    <h5>Surface drift</h5>
                    <div class="form-group" x-ng-if="(!dspToEditIndex && dspToEditIndex != 0 && (sar.dsps && sar.dsps.length > 0)) || dspToEditIndex > 0">
                        <label class="control-label col-xs-5" >
                            <input type="checkbox" x-ng-model="dsp.reuseSurfaceDrifts" x-ng-change="changeReuse()"/>Reuse drift values from first DSP
                        </label>
                        <div class="col-xs-7">
                        </div>
                    </div>

                    <table class="table surfaceDriftPoints">
                        <thead>
                        <tr>
                            <th>Time</th>
                            <th>TWC</th>
                            <th>TWC direction</th>
                            <th>Leeway</th>
                            <th>Leeway direction</th>
                        </tr>
                        </thead>
                        <tbody x-ng-if="!dsp.reuseSurfaceDrifts">
                        <tr ng-form="surfaceDriftForm" x-ng-repeat="surfaceDrift in dsp.surfaceDrifts">
                            <td>
                                <div x-ng-if="$index == 0">
                                    <datetimepicker name="surfaceDriftTs" x-ng-model="surfaceDrift.ts"/>
                                    <span x-ng-if="surfaceDriftForm.surfaceDriftTs.$error.lteq" class="error-block">
                                        Surface drift point must be before drift search position.
                                    </span>
                                </div>
                                <div x-ng-if="$index != 0">
                                    <datetimepicker name="surfaceDriftTs2" x-ng-model="surfaceDrift.ts"/>
                                </div>
                            </td>
                            <td><input x-ng-model="surfaceDrift.twcSpeed" type="text"
                                       class="form-control input-sm" placeholder="5 knots"
                                       required/></td>
                            <td>
                                <input x-ng-model="surfaceDrift.twcDirection" type="text"
                                       class="form-control input-sm"
                                       x-typeahead="direction.name for direction in getDirections($viewValue)"
                                       typeahead-template-url="directionTemplate.html" placeholder="W/270°" required/>
                            </td>
                            <td><input x-ng-model="surfaceDrift.leewaySpeed" type="text"
                                       class="form-control input-sm" placeholder="15 knots" required/></td>
                            <td><input x-ng-model="surfaceDrift.leewayDirection" type="text"
                                       class="form-control input-sm"
                                       x-typeahead="direction.name for direction in getDirections($viewValue)"
                                       typeahead-template-url="directionTemplate.html" placeholder="NE/45°" required/>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="form-group" x-ng-if="!dsp.reuseSurfaceDrifts">
                        <div class="col-xs-12">
                        <span class="pull-right">
                            <button type="button" x-ng-disabled="!dsp.surfaceDrifts || dsp.surfaceDrifts.length == 0"
                                    class="btn btn-sm" x-ng-click="removeLast()">Remove Last</button>
                            <button type="button" class="btn btn-sm" x-ng-click="add()">Add</button>
                        </span>
                        </div>
                    </div>

                    <hr/>

                    <div class="form-group">
                        <div class="col-xs-12">
                        <span class="pull-right">
                            <button type="button" class="btn btn-sm" x-ng-click="cancel()">Cancel</button>
                            <button type="button" class="btn btn-primary btn-sm" x-ng-click="ok(dsp)"
                                    x-ng-disabled="dspForm.$invalid">Finished
                            </button>
                        </span>
                        </div>
                    </div>
                </form>
            </div>

            <div x-ng-if="page.name == 'sarResult'">
                <hr/>
                {{tmp.sarTypeData.text}} with no {{sarOperation.input.no}}
                <hr/>
                <span x-ng-if="sarOperation.input.lastKnownPosition && sarOperation.input.lastKnownPosition.ts">
                    Last known position (LKP): {{formatPos(sarOperation.input.lastKnownPosition)}}<br/>
                    Time of last known position: {{formatTs(sarOperation.input.lastKnownPosition.ts)}} UTC<br/>
                </span>
                Commence Search Start Time: {{formatTs(sarOperation.input.startTs)}} UTC<br/>
                <span x-ng-if="sarOperation.output.hoursElapsed > 0">
                    Time elapsed: {{sarOperation.output.hoursElapsed}} hour<span
                            x-ng-if="sarOperation.output.hoursElapsed != 1">s</span>,
                    {{sarOperation.output.minutesElapsed}} minute<span
                            x-ng-if="sarOperation.output.minutesElapsed != 1">s</span>.<br/>
                </span>
                <hr/>
                <div x-ng-if="sarOperation.input.surfaceDriftPoints.length > 1">
                    Surface drift points:
                    <table class="table table-condensed surfaceDriftPointsPresented">
                        <thead>
                        <tr>
                            <td>Time</td>
                            <td>TWC</td>
                            <td>TWC direction</td>
                            <td>Leeway</td>
                            <td>Leeway direction</td>
                        </tr>
                        </thead>
                        <tbody>
                        <tr x-ng-repeat="surfaceDrift in sarOperation.input.surfaceDriftPoints">
                            <td>{{formatTs(surfaceDrift.ts)}}</td>
                            <td>{{surfaceDrift.twcSpeed}}</td>
                            <td>{{surfaceDrift.twcDirection}}</td>
                            <td>{{surfaceDrift.leewaySpeed}}</td>
                            <td>{{surfaceDrift.leewayDirection}}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div x-ng-if="sarOperation.input.surfaceDriftPoints.length <= 1">
                    <span x-ng-repeat="surfaceDrift in sarOperation.input.surfaceDriftPoints">
                    Total water current {{surfaceDrift.twcSpeed}} knots with direction {{surfaceDrift.twcDirection}}<span
                            x-ng-if="0 <= surfaceDrift.twcDirection && surfaceDrift.twcDirection < 360">°</span>
                    Leeway {{surfaceDrift.leewaySpeed}} knots with direction {{surfaceDrift.leewayDirection}}<span
                            x-ng-if="0 <= surfaceDrift.leewayDirection && surfaceDrift.leewayDirection < 360">°</span><br/>
                    </span>
                </div>
                <hr/>
                Initial position error, X: {{sarOperation.input.xError}} nm<br/>
                SRU navigational error, Y: {{sarOperation.input.yError}} nm<br/>
                Safety factor, Fs: {{sarOperation.input.safetyFactor}}<br/>
                <hr/>
                Search Object: {{searchObjects[sarOperation.input.searchObject].text}} <br/>{{searchObjects[sarOperation.input.searchObject].x}} x U
                <span x-ng-if="searchObjects[sarOperation.input.searchObject].y >= 0">+ {{searchObjects[sarOperation.input.searchObject].y}}</span>
                <span x-ng-if="searchObjects[sarOperation.input.searchObject].y < 0"> - {{-1*searchObjects[sarOperation.input.searchObject].y}}</span>,
                Divergence: {{searchObjects[sarOperation.input.searchObject].divergence}}<br/>
                <hr/>
                <span x-ng-if="sarOperation.output && sarOperation.output.rdv">
                    Datum calculated from applying leeway and total water current: {{formatPos(sarOperation.output.circle.datum)}}<br/>
                    With the following Residual Drift Vector<br/>
                    RDV Direction: {{formatDecimal(sarOperation.output.rdv.direction, -2)}}°<br/>
                    RDV Distance: {{formatDecimal(sarOperation.output.rdv.distance, -2)}} nm<br/>
                    RDV Speed: {{formatDecimal(sarOperation.output.rdv.speed, -2)}} kn/h<br/>
                    With radius: {{formatDecimal(sarOperation.output.circle.radius, -2)}} nm<br/>
                    <hr/>
                </span>
                <span x-ng-if="sarOperation.output && sarOperation.output.downWind.rdv">
                    Datum calculated from applying leeway and total water current: {{formatPos(sarOperation.output.downWind.circle.datum)}}<br/>
                    With the following Residual Drift Vectors<br/>
                    Downwind RDV Direction: {{formatDecimal(sarOperation.output.downWind.rdv.direction, -2)}}°<br/>
                    Downwind RDV Distance: {{formatDecimal(sarOperation.output.downWind.rdv.distance, -2)}} nm<br/>
                    Downwind RDV Speed: {{formatDecimal(sarOperation.output.downWind.rdv.speed, -2)}} kn/h<br/>
                    With downwind radius: {{formatDecimal(sarOperation.output.downWind.circle.radius, -2)}} nm<br/>
                    <hr/>
                </span>
                <span x-ng-repeat="dsp in sarOperation.output.dsps">
                    Drift Search Point {{$index + 1}}<br/>
                    <span x-ng-if="dsp.hoursElapsed > 0">
                        Time elapsed: {{dsp.hoursElapsed}} hour<span x-ng-if="dsp.hoursElapsed != 1">s</span>,
                        {{dsp.minutesElapsed}} minute<span x-ng-if="dsp.minutesElapsed != 1">s</span>.<br/>
                    </span>
                    Datum calculated from applying leeway and total water current: {{formatPos(dsp.downWind.circle.datum)}}<br/>
                    With the following Residual Drift Vector<br/>
                    RDV Direction: {{formatDecimal(dsp.downWind.rdv.direction, -2)}}°<br/>
                    RDV Distance: {{formatDecimal(dsp.downWind.rdv.distance, -2)}} nm<br/>
                    RDV Speed: {{formatDecimal(dsp.downWind.rdv.speed, -2)}} kn/h<br/>
                    With radius: {{formatDecimal(dsp.downWind.circle.radius, -2)}} nm<br/>
                    <hr/>
                </span>

                Search Area:<br/>
                <span x-ng-if="sarOperation.output.searchArea.A">
                    A: {{formatPos(sarOperation.output.searchArea.A)}}<br/>
                    B: {{formatPos(sarOperation.output.searchArea.B)}}<br/>
                    C: {{formatPos(sarOperation.output.searchArea.C)}}<br/>
                    D: {{formatPos(sarOperation.output.searchArea.D)}}<br/>
                </span>
                Total size: {{formatDecimal(sarOperation.output.searchArea.size)}} nm<sup>2</sup><br/>

                <div class="col-xs-12">
                    <span class="pull-right" x-ng-if="!tmp.viewOnly">
                        <button type="button" class="btn btn-sm" x-ng-click="back()">Back</button>
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="finish()">Finish</button>
                        <button type="button" class="btn btn-sm" x-ng-click="close($event)">Cancel</button>
                    </span>
                    <span class="pull-right" x-ng-if="tmp.viewOnly">
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="close($event)">Close</button>
                    </span>
                </div>
            </div>
            <div x-ng-if="page.name == 'backtrackResult'">
                <hr/>
                Back track with no {{sarOperation.input.no}}
                <hr/>
                Observed position: {{formatPos(sarOperation.input.objectPosition)}}<br/>
                Time of observed position: {{formatTs(sarOperation.input.objectPosition.ts)}} UTC<br/>
                Drift calculated back until: {{formatTs(sarOperation.input.driftFromTs)}} UTC<br/>

                <span x-ng-if="sarOperation.output.hoursElapsed > 0">
                    Time elapsed: {{sarOperation.output.hoursElapsed}} hour<span
                        x-ng-if="sarOperation.output.hoursElapsed != 1">s</span>,
                    {{sarOperation.output.minutesElapsed}} minute<span
                        x-ng-if="sarOperation.output.minutesElapsed != 1">s</span>.<br/>
                </span>
                <hr/>

                <div x-ng-if="sarOperation.input.surfaceDriftPoints.length > 1">
                    Surface drift points:
                    <table class="table table-condensed surfaceDriftPointsPresented">
                        <thead>
                        <tr>
                            <td>Time</td>
                            <td>TWC</td>
                            <td>TWC direction</td>
                            <td>Leeway</td>
                            <td>Leeway direction</td>
                        </tr>
                        </thead>
                        <tbody>
                        <tr x-ng-repeat="surfaceDrift in sarOperation.input.surfaceDriftPoints">
                            <td>{{formatTs(surfaceDrift.ts)}}</td>
                            <td>{{surfaceDrift.twcSpeed}}</td>
                            <td>{{surfaceDrift.twcDirection}}</td>
                            <td>{{surfaceDrift.leewaySpeed}}</td>
                            <td>{{surfaceDrift.leewayDirection}}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div x-ng-if="sarOperation.input.surfaceDriftPoints.length <= 1">
                    <span x-ng-repeat="surfaceDrift in sarOperation.input.surfaceDriftPoints">
                    Total water current {{surfaceDrift.twcSpeed}} knots with direction {{surfaceDrift.twcDirection}}<span
                            x-ng-if="0 <= surfaceDrift.twcDirection && surfaceDrift.twcDirection < 360">°</span>
                    Leeway {{surfaceDrift.leewaySpeed}} knots with direction {{surfaceDrift.leewayDirection}}<span
                            x-ng-if="0 <= surfaceDrift.leewayDirection && surfaceDrift.leewayDirection < 360">°</span><br/>
                    </span>
                </div>
                <hr/>
                Initial position error, X: {{sarOperation.input.xError}} nm<br/>
                <hr/>
                Search Object: {{searchObjects[sar.searchObject].text}} <br/>{{searchObjects[sar.searchObject].x}} x U
                <span x-ng-if="searchObjects[sar.searchObject].y >= 0">+ {{searchObjects[sar.searchObject].y}}</span>
                <span x-ng-if="searchObjects[sar.searchObject].y < 0"> - {{-1*searchObjects[sar.searchObject].y}}</span>,
                <hr/>
                <span x-ng-if="sarOperation.output && sarOperation.output.rdv">
                    Residual Drift Vector<br/>
                    RDV Direction: {{formatDecimal(sarOperation.output.rdv.direction, -2)}}°<br/>
                    RDV Distance: {{formatDecimal(sarOperation.output.rdv.distance, -2)}} nm<br/>
                    RDV Speed: {{formatDecimal(sarOperation.output.rdv.speed, -2)}} kn/h<br/>
                    With radius: {{formatDecimal(sarOperation.output.circle.radius, -2)}} nm<br/>
                    <hr/>
                </span>

                Planed route of found object: <br/>
                <span x-ng-repeat="point in sarOperation.input.planedRoute.points">
                    {{formatTs(point.ts)}}, {{formatPos(point)}} <br/>
                </span>
                <hr/>

                Selected positions:<br/>
                <span x-ng-repeat="point in sarOperation.input.selectedPositions">
                    {{sarOperation.input.selectedPositions && sarOperation.input.selectedPositions.length == 1 ? 'LKP:' : ('DSP ' + ($index + 1))}}:
                    {{formatTs(point.ts)}}, {{formatPos(point)}} <br/>
                </span>

                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-sm" x-ng-click="page.name = 'lkp'" x-ng-if="!tmp.viewOnly">Back</button>
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="startNewSar()">Start new SAR</button>
                        <button type="button" class="btn btn-sm" x-ng-click="close($event)"x-ng-if="!tmp.viewOnly">Cancel</button>
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="close($event)" x-ng-if="tmp.viewOnly">Close</button>
                    </span>
                    <span class="pull-right" >
                    </span>
                </div>
            </div>
            <div x-ng-if="page.name == 'tracklineResult'">
                <hr/>
                Track line operation no {{sarOperation.input.no}}
                <hr/>

                Planed route of found object: <br/>
                <span x-ng-repeat="point in sarOperation.input.planedRoute.points">
                    {{formatTs(point.ts)}}, {{formatPos(point)}} <br/>
                </span>
                <hr/>

                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-sm" x-ng-click="page.name = 'route'" x-ng-if="!tmp.viewOnly">Back</button>
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="startTracklineOperation()" x-ng-controller="TracklineResultController">Finish</button>
                        <button type="button" class="btn btn-sm" x-ng-click="close($event)"x-ng-if="!tmp.viewOnly">Cancel</button>
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="close($event)" x-ng-if="tmp.viewOnly">Close</button>
                    </span>
                </div>
            </div>
            <div x-ng-if="page.name == 'end'">
                <hr/>
                Are you sure you wish to end the search and rescue operation {{sar.no}}?
                <hr/>
                NB. The details of this search and rescue operation will remain available in PolarWeb for some time until deleted.
                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="end()">Yes</button>
                        <button type="button" class="btn btn-sm" x-ng-click="cancel()">No</button>
                    </span>
                </div>
            </div>
            <div x-ng-if="page.name == 'archive'">
                <hr/>
                Are you sure you wish to delete the search and rescue operation {{sar.no}}?.
                <hr/>
                <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="archive()">Yes</button>
                        <button type="button" class="btn btn-sm" x-ng-click="cancel()">No</button>
                    </span>
                </div>
            </div>
            <form x-ng-if="page.name == 'coordinator'" name="sarCoordinatorForm" class="form-horizontal" novalidate>
                <div x-ng-controller="SARCoordinatorController">
                    <h5>New coordinator</h5>
                    <hr/>
                    <div class="form-group">
                        <div class="col-xs-12">
                            You are currently the coordinator of the search and rescue operation {{sar.no}}. If you wish
                            you
                            may assign the coordinator role to another user.
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-xs-3">Search user</label>

                        <div class="col-xs-4" x-ng-controller="SARUsersController">
                            <input placeholder="user / mmsi" x-ng-model="coordinator.search"
                                   x-typeahead="user.name for user in getUsers($viewValue)"
                                   x-typeahead-on-select="coordinator.user = $item"
                                   x-typeahead-template-url="userTemplate.html"
                                   class="input-sm form-control e-location-typeahead" type="text"/>
                        </div>
                    </div>

                    <hr/>

                    <div class="form-group">
                        <label class="control-label col-xs-3">Name</label>

                        <div class="col-xs-4">
                            <input x-ng-model="coordinator.user.name" class="input-sm form-control" type="text"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-3">MMSI</label>

                        <div class="col-xs-4">
                            <input x-ng-model="coordinator.user.mmsi" class="input-sm form-control" type="text"/>
                        </div>
                    </div>


                    <div class="col-xs-12">
                    <span class="pull-right">
                        <button type="button" class="btn btn-primary btn-sm" x-ng-click="assign()">Assign</button>
                        <button type="button" class="btn btn-sm" x-ng-click="cancel()">Cancel</button>
                    </span>
                    </div>
                </div>
            </form>
        </div>

    </div>
</div>